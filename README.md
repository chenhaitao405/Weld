# 焊缝检测数据处理流水线

## 项目概述

本项目提供了一套完整的焊缝X射线图像数据处理流水线，能够自动化执行从原始标注数据到模型训练所需格式的全流程处理。通过简单的配置和命令行参数，即可完成数据格式转换、ROI区域提取、图像裁剪增强和训练任务转换等关键步骤，大幅提高数据处理效率。

## 核心功能

- 自动化数据处理流水线，支持分步执行或全流程运行
- Labelme标注格式转YOLO训练格式
- 基于预训练模型的焊缝ROI区域自动提取
- 图像裁剪与增强，提升模型泛化能力
- 分割任务与检测/分类任务间的格式转换

## 环境要求

- Python 3.x
- 依赖库：`tqdm`、`opencv-python`、`ultralytics`等（需自行安装）
- 支持Windows和Linux操作系统（需在配置中正确设置路径）

## 配置说明

核心配置位于`run_data_pipeline.py`的配置区域，主要包括：

1. **路径配置**：根据操作系统自动选择数据路径、模型路径
2. **数据集配置**：指定需要处理的数据集列表
3. **输出目录配置**：定义各步骤输出结果的保存路径
4. **固定参数配置**：各处理步骤的具体参数设置

默认配置支持的数据集：`D1`、`D2`、`D3`、`D4`、`img20250608`、`img20250609`

## 使用方法

### 基本命令格式

```bash
python run_data_pipeline.py --steps [步骤编号] [--force]
```

### 步骤说明

1. **Labelme转YOLO**（步骤1）
   - 将Labelme格式的标注数据转换为YOLO训练格式
   - 支持语义分割标签
   - 可配置是否将所有标签统一为"crack"

2. **YOLO ROI提取**（步骤2）
   - 使用预训练的焊缝检测模型提取感兴趣区域(ROI)
   - 支持设置置信度阈值和IOU阈值
   - 自动生成ROI区域的YOLO格式标签

3. **图像裁剪与增强**（步骤3）
   - 对ROI区域进行滑窗裁剪
   - 支持窗口大小和重叠率配置
   - 提供窗宽窗位等图像增强功能

4. **训练任务转换**（步骤4）
   - 支持从分割任务格式转换为检测或分类任务格式
   - 灵活适配不同类型的模型训练需求

### 示例用法

```bash
# 运行所有4个步骤
python run_data_pipeline.py --steps 1234

# 只运行前3个步骤
python run_data_pipeline.py --steps 123

# 只运行步骤2、3、4
python run_data_pipeline.py --steps 234

# 只运行步骤1和4
python run_data_pipeline.py --steps 14

# 强制运行步骤2（即使前置依赖不存在）
python run_data_pipeline.py --steps 2 --force
```

## 输出说明

处理结果保存在`merge_pick`目录下，包含四个子目录：

- `yolo`：步骤1的输出，YOLO格式的原始数据
- `convert`：步骤2的输出，提取的ROI区域数据
- `patch`：步骤3的输出，裁剪和增强后的图像
- `cls`：步骤4的输出，转换后的分类任务数据

每个步骤的输出会作为后续步骤的输入，形成完整的数据处理链路。

## 注意事项

- 首次运行前请确保配置区域的路径设置正确，特别是模型路径
- 处理大型数据集时可能需要较长时间，请耐心等待
- 若某一步骤失败，建议检查输入数据格式和完整性后再重试
- 可通过`--force`参数强制重新执行某一步骤，但需确保相关依赖数据正确

## 扩展与定制

如需扩展功能，可修改以下配置：

- 在`DATASETS`列表中添加新的数据集名称
- 调整`FIXED_PARAMS`中的参数以优化处理效果
- 修改`OUTPUT_BASE_DIR`更改输出根目录
- 在`STEP_INFO`中添加新的处理步骤（需同时实现对应的处理函数）